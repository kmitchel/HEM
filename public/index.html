<!DOCTYPE html>
<html>
<head>
  <title>Home Energy Monitor</title>
</head>
<body>
  <span id='power'></span>
  <span id='kWh'></span>
  <span id='t'></span>
  <span id='out'></span>
  <span id='upper'></span>
  <span id='lower'></span>
  <span id='achigh'></span>
  <span id='aclow'></span>
  <span id='gal'></span>
  <span id='gpm'></span>
  <span id='rh'></span>
  <span id='dew'></span>
  <span id='trend'></span>
  <img id="watt2" width=100%>
  <br>
  <img id="temp2" width=100%>
  <br>
  <img id="ac2" width=100%>
  <br>
  <img id="wh2" width=100%>
  <br>
  <img id="gpm2" width=100%>
  <br>
  <img id="watt24" width=100%>
  <br>
  <img id="temp24" width=100%>
  <br>
  <img id="ac24" width=100%>
  <br>
  <img id="wh24" width=100%>
  <br>
  <img id="gpm24" width=100%>
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  $(function(){
    var temp = Math.floor(Date.now()/1000/30)*60*1000;
    $('#watt2').attr("src","/graph/watt?" + temp + '&start=4h');
    $('#temp2').attr("src","/graph/temp?" + temp + '&start=4h');
    $('#ac2').attr("src","/graph/ac?" + temp + '&start=4h');
    $('#wh2').attr("src","/graph/wh?" + temp + '&start=4h');
    $('#gpm2').attr("src","/graph/gpm?" + temp + '&start=4h');
    $('#watt24').attr("src","/graph/watt?" + temp + '&start=24h');
    $('#temp24').attr("src","/graph/temp?" + temp + '&start=24h');
    $('#ac24').attr("src","/graph/ac?" + temp + '&start=24h');
    $('#wh24').attr("src","/graph/wh?" + temp + '&start=24h');
    $('#gpm24').attr("src","/graph/gpm?" + temp + '&start=24h');

    var iosocket = io.connect();
    iosocket.on('connect', function(){
      iosocket.on('W', function(message){
        $('#power').html('Current Power:  ' + message + 'W<br>');
      });
      iosocket.on('289C653F03000027', function(message){
        $('#out').html('Outside Temp:  ' + message + 'F<br>');
      });
      iosocket.on('2809853F030000A7', function(message){
        $('#upper').html('Upper WH Temp:  ' + message + 'F<br>');
      });
      iosocket.on('2813513F03000072', function(message){
        $('#lower').html('Lower WH Temp:  ' + message + 'F<br>');
      });
      iosocket.on('2823583F0300006C', function(message){
        $('#achigh').html('High AC Temp:  ' + message + 'F<br>');
      });
      iosocket.on('28AE3A3F0300005E', function(message){
        $('#aclow').html('Low AC Temp:  ' + message + 'F<br>');
      });
      iosocket.on('kWh', function(message){
        var cost = (message * .105 + 19) * 1.07;

        var month;
        new Date().getDate() > 6 ? month = new Date().getMonth() : month = new Date().getMonth() - 1

        var startOfBillingCycle = new Date(new Date().getFullYear(),month,7).getTime();
        var endOfBillingCycle = new Date(new Date().getFullYear(),month+1,7).getTime();

        var projectedkWh = message / (new Date().getTime() - startOfBillingCycle) * (endOfBillingCycle - startOfBillingCycle);

        var projectedCost = (projectedkWh * .105 + 19) * 1.07;

        $('#kWh').html(message + ' kWh @ $' + cost.toFixed(2) + '<br>Projected Monthly Cost:  ' + projectedkWh.toFixed(2) + 'kWh @ $' + projectedCost.toFixed(2) +'<br>');
      });
      iosocket.on('Gal', function(message){
        $('#gal').html('Gallons:  ' + message + '<br>');
      });
      iosocket.on('GPM', function(message){
        $('#gpm').html(message + ' GPM<br>');
      });
      iosocket.on('T', function(message){
        $('#t').html('Inside Temp: ' + message + 'F<br>');
      });
      iosocket.on('RH', function(message){
        $('#rh').html('RH: ' + message + '%<br>');
      });
      iosocket.on('DEW', function(message){
        $('#dew').html('DEW: ' + message + 'F<br>');
      });
      iosocket.on('TREND', function(message){
        $('#trend').html('Trend: ' + message + 'F<br>');
      });
    });
  });
  </script>
</body>
</html>
