<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Home Energy Management</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="site-wrapper">

      <div class="site-wrapper-inner">

        <div class="cover-container">

          <div class="masthead clearfix">
            <div class="inner">
              <div class="alert alert-danger hide" id="disMQTT">MQTT Disconnected</div>
              <h3 class="masthead-brand">Thermostat</h3>
<!--               <nav>
                <ul class="nav masthead-nav">
                  <li class="active"><a href="#">Home</a></li>
                  <li><a href="#">Features</a></li>
                  <li><a href="#">Contact</a></li>
                </ul>
              </nav> -->
            </div>
          </div>

          <div class="inner cover">
            <h1 class="cover-heading"><span id="temp"></span> F</h1>
            <div class="lead">
              <p>Humidity:  <span id="rh"></span> %</p>
              <p>Discomfort:  <span id="di"></span> F</p>
              <p>Outdoor Temp: <span id="out"></span> F </p>
              <p><span id="state"></span></p>
            </div>
            <div>
            <h3 class="text-info">
              Cool Setpoint</h3>
              <span class="btn btn-default btn-xs glyphicon glyphicon-minus disabled" id="coolSetDown"></span>
              <span id="coolSet"></span>
              <span class="btn btn-default btn-xs glyphicon glyphicon-plus disabled" id="coolSetUp"></span>
          </div>
          <div>
            <h3 class="text-danger">
              Heat Setpoint</h3>
              <span class="btn btn-default btn-xs glyphicon glyphicon-minus disabled" id="heatSetDown"></span>
              <span id="heatSet"></span>
              <span class="btn btn-default btn-xs glyphicon glyphicon-plus disabled" id="heatSetUp"></span>
            </div>
            <p class="lead" id="status"></p>
          </div>
<div>
<p><span class="disabled btn btn-danger" id="heat">Heat Mode</span></p>
<p><span class="disabled btn btn-info" id="cool">Cool Mode</span></p>
<p><span class="disabled btn btn-default" id="off">Off Mode</span></p>
</div>
          <div class="mastfoot">
            <div class="inner">
              <p>Home Energy Management</p>
            </div>
          </div>

        </div>

      </div>

    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/paho-mqtt.js"></script>

<script>
$(function() {

var temp = [];

// Create a client instance
client = new Paho.MQTT.Client(location.hostname, Number(9001), 'temp_' + Math.random().toString(16).substr(2, 8));

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({
    onSuccess: onConnect
});
//client.connect();

// called when the client connects
function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    console.log("onConnect");
    client.subscribe("hvac/+");
    client.subscribe("temp/tempF");
    client.subscribe("temp/di");
    client.subscribe("temp/rh");
    client.subscribe("temp/280049724c2001be");

    message = new Paho.MQTT.Message("?");
    message.destinationName = "hvac/coolSet";
    client.send(message);
    message.destinationName = "hvac/heatSet";
    client.send(message);
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:" + responseObject.errorMessage);
    }
    $('#disMQTT').removeClass('hide');
    $('#disMQTT').click(function() {
        client.connect();
        $('#disMQTT').addClass('hide');
    });
}

// called when a message arrives
function onMessageArrived(message) {

    temp[message.destinationName] = message.payloadString;

    switch (message.destinationName) {
        case 'hvac/state':
            $('#state').html(message.payloadString);
            if (message.payloadString.includes("Heat")) {
                $('#cool').removeClass('disabled');
                $('#heat').addClass('disabled');
                $('#off').removeClass('disabled');
            }
            if (message.payloadString.includes("Cool")) {
                $('#heat').removeClass('disabled');
                $('#cool').addClass('disabled');
                $('#off').removeClass('disabled');
            }
            if (message.payloadString.includes("Off")) {
                $('#heat').removeClass('disabled');
                $('#cool').removeClass('disabled');
                $('#off').addClass('disabled');
            }

            break;
        case 'temp/tempF':
            $('#temp').html(message.payloadString);
            break;
        case 'temp/di':
            $('#di').html(message.payloadString);
            break;
        case 'temp/rh':
            $('#rh').html(message.payloadString);
            break;
        case 'hvac/coolSet':
            if (message.payloadString == "?") break
            if (Number(message.payloadString) < 60) {
                messageFix = new Paho.MQTT.Message(Number(60).toString());
                messageFix.destinationName = "hvac/coolSet";
                client.send(messageFix);
            }
            if (Number(message.payloadString) > 85) {
                messageFix = new Paho.MQTT.Message(Number(85).toString());
                messageFix.destinationName = "hvac/coolSet";
                client.send(messageFix);
            }
            $('#coolSet').html(message.payloadString);
            setTimeout(function() {
                $('#coolSetDown').removeClass("disabled");
                $('#coolSetUp').removeClass("disabled");
            }, 250)


            break;
        case 'hvac/heatSet':
            if (message.payloadString == "?") break
            if (Number(message.payloadString) < 60) {
                messageFix = new Paho.MQTT.Message(Number(60).toString());
                messageFix.destinationName = "hvac/heatSet";
                client.send(messageFix);
            }
            if (Number(message.payloadString) > 85) {
                messageFix = new Paho.MQTT.Message(Number(85).toString());
                messageFix.destinationName = "hvac/heatSet";
                client.send(messageFix);
            }
            $('#heatSet').html(message.payloadString);

            setTimeout(function() {
                $('#heatSetDown').delay(1000).removeClass("disabled");
                $('#heatSetUp').delay(1000).removeClass("disabled");
            }, 250)
            break;
        case 'temp/280049724c2001be':
            $('#out').html(message.payloadString);
            break;
    }
}

$('#coolSetDown').click(function() {
    $('#coolSetDown').addClass("disabled")
    $("#coolSetUp").addClass("disabled")
    message = new Paho.MQTT.Message((Number(temp['hvac/coolSet']) - 1).toString());
    message.destinationName = "hvac/coolSet";
    client.send(message);
    message = new Paho.MQTT.Message('?');
    message.destinationName = "hvac/coolSet";
    client.send(message);
});

$('#coolSetUp').click(function() {
    $('#coolSetDown').addClass("disabled")
    $('#coolSetUp').addClass("disabled")
    message = new Paho.MQTT.Message((Number(temp['hvac/coolSet']) + 1).toString());
    message.destinationName = "hvac/coolSet";
    client.send(message);
    message = new Paho.MQTT.Message('?');
    message.destinationName = "hvac/coolSet";
    client.send(message);
});

$('#heatSetDown').click(function() {
    $('#heatSetDown').addClass("disabled");
    $('#heatSetUp').addClass("disabled");
    message = new Paho.MQTT.Message((Number(temp['hvac/heatSet']) - 1).toString());
    message.destinationName = "hvac/heatSet";
    client.send(message);
    message = new Paho.MQTT.Message('?');
    message.destinationName = "hvac/heatSet";
    client.send(message);
});

$('#heatSetUp').click(function() {
    $('#heatSetDown').addClass("disabled");
    $('#heatSetUp').addClass("disabled");
    message = new Paho.MQTT.Message((Number(temp['hvac/heatSet']) + 1).toString());
    message.destinationName = "hvac/heatSet";
    client.send(message);
    message = new Paho.MQTT.Message('?');
    message.destinationName = "hvac/heatSet";
    client.send(message);
});

$('#heat').click(function() {
    message = new Paho.MQTT.Message("heat");
    message.destinationName = "hvac/mode";
    client.send(message);
    $('#heat').addClass('disabled');
});

$('#cool').click(function() {
    message = new Paho.MQTT.Message("cool");
    message.destinationName = "hvac/mode";
    client.send(message);
    $('#cool').addClass('disabled');
});

$('#off').click(function() {
    message = new Paho.MQTT.Message("off");
    message.destinationName = "hvac/mode";
    client.send(message);
    $('#off').addClass('disabled');
});

});
</script>

  </body>
</html>
